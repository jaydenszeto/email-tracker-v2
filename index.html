<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-12">
            <h1 class="text-4xl font-bold text-white mb-2">Email Tracker</h1>
            <p class="text-lg text-gray-400">Generate a tracking pixel and monitor your email opens in real-time.</p>
        </header>

        <!-- Generator Section -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 md:p-8 mb-12">
            <h2 class="text-2xl font-semibold text-white mb-4">Generate Tracking Pixel</h2>
            <div class="flex flex-col md:flex-row items-end gap-4">
                <div class="w-full">
                    <label for="campaign-name" class="block text-sm font-medium text-gray-400 mb-2">Campaign or Subject Name</label>
                    <input type="text" id="campaign-name" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., Q4 Newsletter">
                </div>
                <button id="generate-btn" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-200 whitespace-nowrap">
                    Generate
                </button>
            </div>

            <!-- Result Display -->
            <div id="result-area" class="mt-6 hidden">
                <label class="block text-sm font-medium text-gray-400 mb-2">Your Tracking Snippet (copy and paste into your email's HTML)</label>
                <div class="bg-gray-900 rounded-md p-4 flex items-center justify-between">
                    <code id="html-snippet" class="text-yellow-300 text-sm overflow-x-auto"></code>
                    <button id="copy-btn" class="ml-4 bg-gray-600 hover:bg-gray-500 text-white font-semibold py-1 px-3 rounded-md text-sm">
                        Copy
                    </button>
                </div>
            </div>
        </div>

        <!-- Events Log Section -->
        <div>
            <h2 class="text-2xl font-semibold text-white mb-4">Real-Time Open Events</h2>
            <div class="bg-gray-800 rounded-lg shadow-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-300">
                        <thead class="text-xs text-gray-400 uppercase bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3">Timestamp</th>
                                <th scope="col" class="px-6 py-3">Campaign</th>
                                <th scope="col" class="px-6 py-3">IP Address</th>
                                <th scope="col" class="px-6 py-3">Client / User Agent</th>
                            </tr>
                        </thead>
                        <tbody id="events-table-body">
                           <!-- Rows will be injected here by JavaScript -->
                           <tr id="placeholder-row">
                               <td colspan="4" class="text-center px-6 py-12 text-gray-500">
                                   No open events recorded yet. Send an email with your pixel to see data here.
                                </td>
                           </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generate-btn');
            const resultArea = document.getElementById('result-area');
            const htmlSnippetEl = document.getElementById('html-snippet');
            const copyBtn = document.getElementById('copy-btn');
            const campaignInput = document.getElementById('campaign-name');
            const eventsTableBody = document.getElementById('events-table-body');
            const placeholderRow = document.getElementById('placeholder-row');

            // --- Generate Pixel ---
            generateBtn.addEventListener('click', async () => {
                const campaignName = campaignInput.value || 'Untitled Campaign';
                
                try {
                    const response = await fetch('/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ campaign: campaignName })
                    });
                    const data = await response.json();
                    
                    htmlSnippetEl.textContent = data.html_snippet;
                    resultArea.classList.remove('hidden');
                    copyBtn.textContent = 'Copy'; // Reset copy button text
                } catch (error) {
                    console.error('Error generating pixel:', error);
                    htmlSnippetEl.textContent = 'Error: Could not generate pixel.';
                }
            });

            // --- Copy to Clipboard ---
            copyBtn.addEventListener('click', () => {
                // Use execCommand for broader compatibility, especially in iFrames
                const textToCopy = htmlSnippetEl.textContent;
                const tempTextarea = document.createElement('textarea');
                tempTextarea.value = textToCopy;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                try {
                    document.execCommand('copy');
                    copyBtn.textContent = 'Copied!';
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    copyBtn.textContent = 'Error';
                }
                document.body.removeChild(tempTextarea);
            });

            // --- Fetch and Display Events ---
            const fetchEvents = async () => {
                try {
                    const response = await fetch('/events');
                    const events = await response.json();
                    
                    if (events.length > 0) {
                        placeholderRow.classList.add('hidden');
                    } else {
                        placeholderRow.classList.remove('hidden');
                    }
                    
                    // Clear existing rows
                    eventsTableBody.innerHTML = '';
                    if (events.length === 0) {
                        eventsTableBody.appendChild(placeholderRow);
                    }

                    // Add new rows
                    events.forEach(event => {
                        const row = document.createElement('tr');
                        row.className = 'bg-gray-800 border-b border-gray-700 hover:bg-gray-600/50';
                        row.innerHTML = `
                            <td class="px-6 py-4 table-cell font-medium text-white">${event.timestamp}</td>
                            <td class="px-6 py-4 table-cell">${event.campaign}</td>
                            <td class="px-6 py-4 table-cell">${event.ip_address}</td>
                            <td class="px-6 py-4 table-cell text-gray-400">${event.user_agent}</td>
                        `;
                        eventsTableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error fetching events:', error);
                }
            };
            
            // Fetch events every 3 seconds
            setInterval(fetchEvents, 3000);
            fetchEvents(); // Initial fetch
        });
    </script>

</body>
</html>
